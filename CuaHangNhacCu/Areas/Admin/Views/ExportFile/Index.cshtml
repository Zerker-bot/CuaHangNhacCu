@* File: Index.cshtml *@

@{
    ViewData["Title"] = "Công Cụ Kế Toán & Vận Chuyển";
    // Giả sử Layout của bạn là _AdminLayout
    // Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container mt-5">
    <h2>Công Cụ Kế Toán & Vận Chuyển</h2>
    <hr />

    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">📦 Xuất Danh Sách Đơn Hàng Ship</h5>
                </div>
                <div class="card-body text-center">
                    <p>Tạo file CSV chứa chi tiết các đơn hàng đang ở trạng thái **Đang Xử Lý** để tiến hành gom hàng và giao nhận.</p>

                    <a asp-area="Admin"
                       asp-controller="ExportFile"
                       asp-action="ExportPendingOrders"
                       class="btn btn-success btn-lg mt-3">
                        <i class="fas fa-file-export"></i> Tải File Đơn Hàng Chờ Ship
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">📈 Xem Thống Kê Doanh Thu</h5>
                </div>
                <div class="card-body text-center">
                    <p>Xem tổng quan về số lượng đơn hàng và tổng doanh thu theo đơn vị thời gian (Tuần hoặc Tháng).</p>

                    <button id="btn-show-month-summary"
                            data-type="month"
                            class="btn btn-warning btn-lg mt-3">
                        <i class="fas fa-chart-line"></i> Xem Thống Kê Tháng
                    </button>
                    <button id="btn-show-week-summary"
                            data-type="week"
                            class="btn btn-secondary btn-lg mt-3">
                        <i class="fas fa-calendar-week"></i> Xem Thống Kê Tuần
                    </button>

                    <div class="mt-3">
                        <label for="lookback-select" class="form-label">Số kỳ (Tuần/Tháng) gần nhất:</label>
                        <select id="lookback-select" class="form-select w-auto d-inline-block">
                            <option value="1">1</option>
                            <option value="3" selected>3</option>
                            <option value="6">6</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr />

    <div id="sales-summary-container" class="mt-5">
        <div class="alert alert-info" role="alert">
            Nhấn vào nút **Xem Thống Kê** để tải dữ liệu doanh thu.
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hàm AJAX chung để tải thống kê
            function loadSalesSummary(type) {
                const lookback = $('#lookback-select').val();
                // **Lưu ý:** Nếu Area là "Admin" không hoạt động, hãy thử xóa 'area':
                // const url = '@Url.Action("GetSalesSummary", "ExportFile")';
                const url = '@Url.Action("GetSalesSummary", "ExportFile", new { area = "Admin" })';

                // Hiển thị thông báo đang tải
                $('#sales-summary-container').html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i> Đang tải dữ liệu...</div>');

                $.ajax({
                    url: url,
                    type: 'GET',
                    data: {
                        type: type,
                        lookback: lookback
                    },
                    success: function (data) {
                        // Nhúng partial view vào container
                        $('#sales-summary-container').html(data);
                    },
                    error: function (xhr, status, error) {
                        $('#sales-summary-container').html('<div class="alert alert-danger">Lỗi khi tải dữ liệu thống kê: ' + error + '</div>');
                    }
                });
            }

            // Gán sự kiện click cho nút Thống Kê Tháng
            $('#btn-show-month-summary').click(function () {
                loadSalesSummary('month');
            });

            // Gán sự kiện click cho nút Thống Kê Tuần
            $('#btn-show-week-summary').click(function () {
                loadSalesSummary('week');
            });

            // **THÊM XỬ LÝ SỰ KIỆN CHO NÚT ĐÓNG BẢNG (Nằm trong Partial View)**
            // Dùng .on() để bắt sự kiện của phần tử được tải động (Partial View)
            $('#sales-summary-container').on('click', '#btn-hide-summary', function () {
                $('#sales-summary-container').html(
                    '<div class="alert alert-info" role="alert">Nhấn vào nút **Xem Thống Kê** để tải dữ liệu doanh thu.</div>'
                );
            });
        });
    </script>
}