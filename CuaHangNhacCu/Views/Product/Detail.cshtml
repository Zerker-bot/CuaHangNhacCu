@using Microsoft.AspNetCore.Authentication
@inject IHttpContextAccessor HttpContextAccessor
@using CuaHangNhacCu.ViewModels.Product
@model ProductDetail 
@{
  var product = Model.Product;
  ViewData["Title"] = product.Name;
}

@section Styles {
  <link href="/css/customer/product/detail.css" rel="stylesheet">
}

<div class="container py-4">
    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="position-relative">
                @await Html.PartialAsync("_SlideShow", product);
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card border-0 h-100">
                <div class="card-body">
                    <h1 class="section-title display-6 fw-bold text-dark mb-2">@product.Name<h1>
                    <p class="text-muted mb-3">@product.Category.Name • @product.Brand.Name</p>
                    
                    <div class="mb-4">
                        <h3 class="text-dark fw-bold">
                                @product.Price.ToString("C", new System.Globalization.CultureInfo("vi-VN"))
                        </h3>
                    </div>


                    <div class="mb-4">
                        <h6 class="fw-bold text-dark mb-3">
                            <i class="fas fa-star text-gold me-2"></i>Nổi bật
                        </h6>
                        <ul class="list-unstyled fs-6">
                            <li class="mb-2"><i class="fas fa-check text-gold me-2"></i>Hãng @product.Brand.Name cao cấp</li>
                            <li class="mb-2"><i class="fas fa-check text-gold me-2"></i>Free ship cho đơn từ 50 triệu</li>
                            <li class="mb-2"><i class="fas fa-check text-gold me-2"></i>Chính sách đổi trả trong 30 ngày</li>
                            <li class="mb-2"><i class="fas fa-check text-gold me-2"></i>Bảo hành 2 năm</li>
                        </ul>
                    </div>

                    <div class="alert alert-success d-flex align-items-center fs-6">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        <strong>Số lượng trong kho:</strong>&nbsp;@product.Quantity  
                    </div>

                    <form asp-controller="Cart" asp-action="BuyNow" method="post">
                        @Html.AntiForgeryToken()

                        <input type="hidden" name="productId" value="@product.Id" />

                        <div class="align-items-end mb-4 w-100">
                            <div class="col-md-8 w-100">
                                <label class="form-label fw-semibold text-dark mb-2 fs-6">Số lượng</label>
                                <div class="input-group w-50">
                                    <button class="btn btn-outline-dark border-gold quantity-btn" data-type="minus" type="button">-</button>
                                    <input type="number" class="form-control text-center border-0 quantity-input" value="1" min="1" id="quantity-input" name="quantity">
                                    <button class="btn btn-outline-dark border-gold quantity-btn" data-type="plus" type="button">+</button>
                                </div>
                            </div>
                            <div class="col-md-4 w-100">
                                <button class="btn btn-blue btn-md w-100" type="submit">
                                    <i class="bi bi-handbag-fill me-2"></i>Mua ngay
                                </button>

                                <button class="btn btn-gold btn-md w-100" id="btn-add-to-cart" data-product-id="@product.Id" type="button">
                                    <i class="fas fa-shopping-cart me-2"></i>Thêm vào giỏ hàng
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">

    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs nav-tabs-custom mb-4 justify-content-center" id="productTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button">
                        <i class="fas fa-align-left me-2"></i>Mô tả
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button">
                        <i class="fas fa-comments me-2"></i>Đánh giá
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="productTabsContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h3 class="section-title fw-bold text-dark mb-4">Mô tả sản phẩm</h3>
                            @Html.Raw(Model.Product.Description)
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    @if(User?.Identity?.IsAuthenticated ?? false) 
                    {
                      <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white border-0">
                        <h5 class="card-title mb-0 fw-bold text-dark">
                        <i class="fas fa-comment-dots text-gold me-2"></i>Thêm nhận xét của bạn
                        </h5>
                        </div>
                        <div class="card-body">
                        <form method="post" asp-action="CreateReview" asp-controller="Product" asp-route-productId="@product.Id">
                            <div class="mb-3">
                              <label for="rating" class="form-label fw-semibold text-dark mb-2 fs-6">Đánh giá của bạn</label>
                              <input name="rating" type="number" id="rating" hidden/>
                              <div class="star-rating">
                              <i class="bi bi-star text-gold" data-rating="1"></i>
                              <i class="bi bi-star text-gold" data-rating="2"></i>
                              <i class="bi bi-star text-gold" data-rating="3"></i>
                              <i class="bi bi-star text-gold" data-rating="4"></i>
                              <i class="bi bi-star text-gold" data-rating="5"></i>
                              </div>
                            </div>
                      <div class="mb-3">
                        <textarea name="content" class="form-control" rows="4" placeholder="Share your experience with this product..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-gold">
                        <i class="fas fa-paper-plane me-2"></i>Đăng
                        </button>
                        </form>
                        </div>
                        </div>
                    } else {
                      <div class="text-center py-5">
                        <i class="fas fa-user-lock fa-3x text-gold mb-3"></i>
                        <h4 class="text-dark">Đăng nhập để được gửi nhận xét</h4>
                        <a href="@Url.Action("Login")" class="btn btn-gold mt-3">Đăng nhập</a>
                        </div>
                    }

                    <div class="row g-4">
                    @if (product.Reviews.Any())
                    {
                    
                      @foreach (var review in product.Reviews)
                      {

                        <div class="col-12">
                          <div class="card border-0">
                            <div class="card-body">
                              <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                  <i class="fas fa-user-circle fa-3x text-gold"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                  <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0 fw-bold text-dark">@review.User.UserName</h6>
                                    <div class="d-flex">
                                      @for(int i = 0; i < review.Rating; i++) 
                                      {
                                          <i class="bi bi-star-fill text-gold"></i>
                                      }
                                      @for(int i = review.Rating; i < 5; i++) 
                                      {
                                          <i class="bi bi-star text-gold"></i>
                                      }
                                      <span class="text-muted ms-2 small">@review.CreatedAt</span>
                                   </div>
                                 </div>
                                </div>
                            </div>
                            <div class="p-4">
                            @review.Content
                            </div>
                          </div>
                        </div>
                      </div>
                      }
                    } else {
                      <div class="col-12 text-center py-5">
                        <i class="fas fa-comments fa-3x text-gold mb-3"></i>
                        <h5 class="text-dark">Chưa có nhận xét nào</h5>
                        <p class="text-muted">Hãy trở thành người đầu tiên bình luận</p>
                        </div>
                    }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {

  <script>
    function showImage(img) {
      const main = document.getElementById("main-image");
      main.src = img.src;

      document.querySelectorAll(".thumbnails img").forEach(el => el.classList.remove("active"));
      img.classList.add("active");
    }
  </script>
  <script>
  document.querySelectorAll('.quantity-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const input = this.parentElement.querySelector('.quantity-input');
      let value = parseInt(input.value) || 1;

      if (this.dataset.type === 'plus') {
        value++;
      } else if (this.dataset.type === 'minus' && value > parseInt(input.min || 1)) {
        value--;
      }

      input.value = value;
    });
  });

    const stars = document.querySelectorAll('.star-rating i');
    const ratingInput = document.getElementById('rating');
    
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = this.dataset.rating;
            ratingInput.value = rating;
            
            stars.forEach(s => {
                s.classList.remove('bi-star-fill');
                s.classList.remove('bi-star');
            });
            stars.forEach((s, index) => {
                if (index < rating) {
                s.classList.add('bi-star-fill');
                } else {
                s.classList.add('bi-star');
                }
            });
        });
    });
</script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.getElementById('btn-add-to-cart').addEventListener('click', function() {
            var productId = this.dataset.productId;
            var quantity = document.getElementById('quantity-input').value;

            var token = document.querySelector('input[name="__RequestVerificationToken"]');
            var headers = {};
            if (token) {
                headers['RequestVerificationToken'] = token.value;
            }

            fetch('/Cart/AddToCart', {
                method: 'POST',
                headers: {
                    ...headers,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `productId=${productId}&quantity=${quantity}`
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    Swal.fire({
                        title: "Thành công!",
                        text: data.message,
                        icon: "success",
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        title: "Lỗi!",
                        text: data.message || "Không thể thêm vào giỏ hàng.",
                        icon: "error"
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: "Lỗi!",
                    text: "Đã xảy ra lỗi. Vui lòng thử lại.",
                    icon: "error"
                });
            });
        });
    </script>
}
