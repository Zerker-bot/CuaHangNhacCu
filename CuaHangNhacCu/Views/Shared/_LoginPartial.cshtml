@using Microsoft.AspNetCore.Identity
@using CuaHangNhacCu.Models
@using CuaHangNhacCu.Data
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
@inject ApplicationDbContext _context

@{
    int cartCount = 0;
    if (SignInManager.IsSignedIn(User))
    {
        var userId = User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (userId != null)
        {
            var cart = await _context.Carts.Include(c => c.Items)
                                     .FirstOrDefaultAsync(c => c.UserId == userId);
            if (cart != null)
            {
                cartCount = cart.Items.Sum(i => i.Quantity);
            }
        }
    }
}

<ul class="navbar-nav align-items-center gap-2">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        var fullName = user?.FullName ?? User.Identity?.Name ?? "Khách hàng";
        var displayName = fullName.Length > 15 ? fullName.Substring(0, 12) + "..." : fullName;
        var avatarUrl = "https://avatar.iran.liara.run/public/43";

        <li class="nav-item">
            <a class="nav-link btn btn-light border rounded-pill px-3 position-relative nav-btn-fixed"
               asp-area="" asp-controller="Cart" asp-action="Index" title="Giỏ hàng">

                <i class="bi bi-cart3 fs-5 text-dark"></i>

                @if (cartCount > 0)
                {
                    <span class="position-absolute badge rounded-circle bg-danger border border-2 border-white cart-badge">
                        @cartCount
                    </span>
                }
                else
                {
                    <span class="position-absolute badge rounded-circle bg-secondary border border-2 border-white cart-badge">
                        0
                    </span>
                }
            </a>
        </li>

        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle d-flex align-items-center p-1 ps-3 pe-2 border rounded-pill bg-white shadow-sm hover-shadow user-dropdown-toggle"
               href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">

                <div class="d-flex flex-column align-items-end me-2 lh-1">
                    <span class="text-muted user-greeting">Xin chào,</span>
                    <span class="fw-bold text-dark user-name-display">@displayName</span>
                </div>
                <img src="@avatarUrl" alt="Avatar" class="rounded-circle border user-dropdown-avatar">
            </a>

            <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 mt-2 rounded-3 overflow-hidden p-2" aria-labelledby="navbarDropdown">
                <li>
                    <div class="px-3 py-2 border-bottom mb-2 bg-light rounded-top">
                        <div class="fw-bold text-dark user-name-display">@fullName</div>
                        <div class="text-muted text-truncate user-email-display">
                            @User.Identity?.Name
                        </div>
                    </div>
                </li>
                <li>
                    <a class="dropdown-item rounded-2 py-2 mb-1" asp-area="" asp-controller="Profile" asp-action="Index">
                        <i class="bi bi-person-gear me-2 text-primary"></i>Hồ sơ cá nhân
                    </a>
                </li>
                <li>
                    <a class="dropdown-item rounded-2 py-2 mb-1" asp-area="" asp-controller="OrderHistory" asp-action="Index">
                        <i class="bi bi-receipt me-2 text-info"></i>Đơn hàng của tôi
                    </a>
                </li>
                <li><hr class="dropdown-divider my-2"></li>
                <li>
                    <form class="form-inline" asp-controller="Account" asp-action="Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                        <button type="submit" class="dropdown-item rounded-2 py-2 text-danger d-flex align-items-center w-100">
                            <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                        </button>
                    </form>
                </li>
            </ul>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="btn btn-outline-dark rounded-pill fw-semibold nav-btn-fixed nav-btn-auth"
               asp-controller="Account" asp-action="Register">
                <i class="bi bi-person-plus me-2"></i>Đăng ký
            </a>
        </li>
        <li class="nav-item">
            <a class="btn btn-gold rounded-pill fw-semibold border-0 text-dark shadow-sm nav-btn-fixed nav-btn-auth"
               asp-controller="Account" asp-action="Login">
                <i class="bi bi-box-arrow-in-right me-2"></i>Đăng nhập
            </a>
        </li>
    }
</ul>